<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rastreio | Multi Express</title>
  <meta name="color-scheme" content="light only" />
  <style>
    :root{ --azul-escuro:#0B1F4E; --azul:#2E5AA7; --cinza:#f3f5f9; --borda:#e3e7ee; }
    *{box-sizing:border-box}
    body{ margin:0; background:linear-gradient(180deg,var(--cinza),#fff);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#0e1b2b;
      min-height:100dvh; display:grid; place-items:center; padding:24px; }
    .card{ width:min(760px,94vw); background:#fff; border:1px solid var(--borda);
      border-radius:20px; box-shadow:0 10px 30px rgba(11,31,78,.08); padding:28px 22px; }
    .brand{display:flex; align-items:center; gap:14px; margin-bottom:18px}
    .brand img{height:44px}
    h1{font-size:20px; margin:0; color:#0B1F4E}
    .muted{color:#3b4a66; font-size:13px}
    form{display:grid; grid-template-columns:1fr 1fr auto; gap:12px; margin-top:14px}
    label{font-size:12px; color:#4a5a78; display:block; margin:2px 0 6px}
    input{ width:100%; border:1px solid var(--borda); border-radius:12px; padding:12px 12px;
      font-size:14px; outline:none; transition:border .2s, box-shadow .2s; }
    input:focus{border-color:#2E5AA7; box-shadow:0 0 0 4px rgba(46,90,167,.12)}
    button{ border:0; border-radius:12px; padding:0 18px; font-weight:600; font-size:14px;
      background:#0B1F4E; color:#fff; cursor:pointer; min-height:44px; align-self:end; }
    button:disabled{opacity:.55; cursor:not-allowed}
    .status{margin-top:14px; font-size:13px}
    .results{margin-top:16px; border-top:1px dashed var(--borda); padding-top:16px}
    .item{border:1px solid var(--borda); border-radius:14px; padding:12px; margin:10px 0; background:#fff}
    .i-title{font-weight:700; color:#0B1F4E; font-size:14px}
    .i-sub{font-size:12px; color:#44536f}
    .bad{color:#8b1a1a}
    @media (max-width:760px){ form{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <main class="card" role="main" aria-label="Rastreio de NF - Multi Express">
    <div class="brand">
      <img src="logo.png" alt="Logo Multi Express" />
      <div>
        <h1>Rastreio de Nota Fiscal</h1>
        <div class="muted">Informe o <strong>CNPJ do remetente</strong> e a <strong>NF</strong>.</div>
      </div>
    </div>

    <form id="form">
      <div class="field">
        <label for="cnpj">CNPJ do Remetente</label>
        <input id="cnpj" name="cnpj" placeholder="00.000.000/0000-00" required />
      </div>
      <div class="field">
        <label for="nf">NF (nº do documento)</label>
        <input id="nf" name="nf" placeholder="Ex.: 123456" required />
      </div>
      <button id="btn" type="submit">Rastrear</button>
    </form>

    <div id="status" class="status" role="status" aria-live="polite"></div>
    <section id="results" class="results" hidden></section>
  </main>

  <script>
    const form   = document.getElementById('form');
    const status = document.getElementById('status');
    const results= document.getElementById('results');
    const btn    = document.getElementById('btn');

    function sanitizeCNPJ(v){ return v.replace(/[^\d]/g,''); }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      results.hidden = true; results.innerHTML = "";
      status.textContent = "Consultando..."; btn.disabled = true;

      const cnpj = sanitizeCNPJ(document.getElementById('cnpj').value.trim());
      const nf   = document.getElementById('nf').value.trim();

      try{
        const r = await fetch(`/api/track?cnpj=${encodeURIComponent(cnpj)}&nf=${encodeURIComponent(nf)}`);
        if(!r.ok){
          let msg = r.statusText;
          try{
            const err = await r.json();
            if(err?.message) msg = err.message;
          }catch(_) {}
          throw new Error(msg || `Erro ${r.status}`);
        }
        const data = await r.json();

        status.textContent = "Resultado encontrado.";
        results.hidden = false;

        const header = document.createElement('div');
        header.className = 'item';
        header.innerHTML = `
          <div class="i-title">NF ${nf}</div>
          <div class="i-sub">CNPJ Remetente: ${cnpj}</div>
        `;
        results.appendChild(header);

        const eventos = Array.isArray(data?.dados?.eventos) ? data.dados.eventos
                       : Array.isArray(data?.eventos) ? data.eventos
                       : Array.isArray(data) ? data : [];

        if(eventos.length === 0){
          const empty = document.createElement('div');
          empty.className = 'i-sub bad';
          empty.textContent = 'Nenhuma ocorrência encontrada para os parâmetros informados.';
          results.appendChild(empty);
        }else{
          for(const ev of eventos){
            const it = document.createElement('div');
            it.className = 'item';
            const titulo = ev?.descricao || ev?.status || 'Ocorrência';
            const quando = ev?.data || ev?.data_hora || ev?.datetime || '';
            const onde   = ev?.local || ev?.cidade || '';
            it.innerHTML = `
              <div class="i-title">${titulo}</div>
              <div class="i-sub">${quando}${onde ? " • " + onde : ""}</div>
              ${ev?.detalhe ? `<div class="i-sub">${ev.detalhe}</div>` : ""}
            `;
            results.appendChild(it);
          }
        }
      }catch(err){
        status.innerHTML = `<span class="bad">Falha na consulta:</span> ${err.message}`;
      }finally{
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
